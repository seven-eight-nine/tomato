name: Sync merged PR to Azure DevOps
on:
  pull_request:
    types: [closed]
jobs:
  sync-merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      - name: Create patch from PR
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          MERGE_COMMIT=${{ github.event.pull_request.merge_commit_sha }}
          git show $MERGE_COMMIT --format="%B" > pr_message.txt
          git diff ${MERGE_COMMIT}^..${MERGE_COMMIT} > changes.patch
      - name: Push to Azure DevOps as PR branch
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZDO_ORG: ${{ secrets.AZDO_ORG }}
          AZDO_PROJECT: ${{ secrets.AZDO_PROJECT }}
          AZDO_REPO: ${{ secrets.AZDO_REPO }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          BRANCH_NAME="github/pr-${PR_NUM}"
          git remote add azdo https://${AZURE_DEVOPS_PAT}@dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_git/${AZDO_REPO}
          git fetch azdo main
          git checkout -b $BRANCH_NAME azdo/main
          if git apply --check changes.patch 2>/dev/null; then
            git apply changes.patch
            git add -A
            git commit -m "[GitHub PR #${PR_NUM}] ${PR_TITLE}" \
              -m "Merged from: ${{ github.event.pull_request.html_url }}" \
              -m "Author: ${{ github.event.pull_request.user.login }}"
            git push azdo $BRANCH_NAME
            echo "PUSH_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "PUSH_SUCCESS=false" >> $GITHUB_ENV
          fi
      - name: Create PR in Azure DevOps
        if: env.PUSH_SUCCESS == 'true'
        env:
          AZURE_DEVOPS_EXT_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZDO_ORG: ${{ secrets.AZDO_ORG }}
          AZDO_PROJECT: ${{ secrets.AZDO_PROJECT }}
          AZDO_REPO: ${{ secrets.AZDO_REPO }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          BRANCH_NAME="github/pr-${PR_NUM}"
          az extension add --name azure-devops
          az devops configure --defaults organization=https://dev.azure.com/${AZDO_ORG} project=${AZDO_PROJECT}
          az repos pr create \
            --repository ${AZDO_REPO} \
            --source-branch $BRANCH_NAME \
            --target-branch main \
            --title "[GitHub PR #${PR_NUM}] ${PR_TITLE}" \
            --description "GitHub から自動同期されたPRです。"
      - name: Comment on GitHub PR (success)
        if: env.PUSH_SUCCESS == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: '✅ Azure DevOps にPRを作成しました。'
            })
      - name: Comment on GitHub PR (conflict)
        if: env.PUSH_SUCCESS == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: '⚠️ コンフリクトが発生しました。手動での対応が必要です。'
            })
